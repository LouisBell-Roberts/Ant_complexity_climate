---
title: "The Can of Worms Project"
subtitle: "An in-progress reanalysis of NatEcolEvol bird dataset and the analysis of global ant dataset"
author: "Ming Liu"
output:
  pdf_document:
    number_sections: true
    fig_caption: true
    includes:  
      in_header: preamble-latex.tex
urlcolor: blue
date: \today
---

\tableofcontents
\newpage 

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message=F, warning=F)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = T)
# Packages
library(data.table)
library(ape)
library(ggtree) ## Basic ggplot package for trees
library(ggtreeExtra) ## For fancy tree plotting
library(ufs) ## For ggqq plot
library(phylolm)
library(rr2)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(stringr)
theme_set(theme_minimal())
```

# Basic diagnostic of the bird dataset
## Table of abbreviations

```{r abbr_table_bird, echo=FALSE, warning= FALSE}
library(kableExtra)
library(stringr)
abbr<- c("TMP_avg", "TMP_sd", "TMP_prd_entropy", "TMP_prd_Colwell_Botero", "TMP_prd_Colwell_25",
         "PRE_avg", "PRE_sd", "PRE_prd_entropy", "PRE_prd_Colwell_Botero", "PRE_prd_Colwell_25",
         "DTR_avg", "DTR_sd", "DTR_prd_entropy", "DTR_prd_Colwell_25")
full<- c("Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictability using Carlos Botero's binning", "Colwell's predictabilty with dynamic bin size",
         "Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictability using Carlos Botero's binning", "Colwell's predictabilty with dynamic bin size",
         "Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictabilty with dynamic bin size")
trsf<- c("sqrt", "none", "none", "none", "none", "sqrt", "sqrt", "none", "none", "none", "sqrt", "none", "none", "none")
table<- cbind(abbr, full, trsf)
colnames(table)<- c("Name", "Description", "Transformation")
knitr::kable(table, "latex", align=c("l","l","c"), booktabs = T, caption= "The abbreviations used in axes titles and column names of the data.") %>%
  group_rows("Temperature", 1, 5) %>%
  group_rows("Precipiration (rainfall)", 6, 10) %>%
  group_rows("Diurnal temperature range", 11, 14) %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

## Read-in the bird data

```{r read-in_bird}
# Read in the files
bird_data<- fread("Data/Bird_Env_17Mar.csv")
bird_tree<- read.tree("Data/Bird_Tree_17Mar.tre")
```

## Normality check of the climatic predictors (averages)

```{r bird_normality,fig.width=8,fig.height=2.5,fig.cap="Climate variables normality check."}
a<- ggqq(bird_data$TMP_avg_tr, observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (sqrt(TMP_avg))")
b<- ggqq(bird_data$PRE_avg_tr, observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (sqrt(PRE_avg))")
c<- ggqq(bird_data$DTR_avg_tr, observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (sqrt(DTR_avg))")
ggarrange(a,b,c,nrow=1, labels=c("a","b","c"))
```

## How does cooperative breeding trait distribute across climatic variables?

```{r bird_binary_pattern, fig.width=8, fig.height=2.5, fig.cap="Climate variables against polymorphic worker trait in ants."}
a<- ggplot(bird_data, aes(x=TMP_avg_tr, y=COOP2))+
  geom_point(alpha= 0.2)+
  ylab("Cooperative breeding")
b<- ggplot(bird_data, aes(x=PRE_avg_tr, y=COOP2))+
  geom_point(alpha= 0.2)+
  ylab("Cooperative breeding")
c<- ggplot(bird_data, aes(x=DTR_avg_tr, y=COOP2))+
  geom_point(alpha= 0.2)+
  ylab("Cooperative breeding")
ggarrange(a,b,c,nrow=1, labels=c("a","b","c"))
```

## How does cooperative breeding trait distribute across the phelogenetic tree?

```{r bird_tree, fig.width=5, fig.height=5, fig.cap="Phylogenetic tree of all bird species."}
nicer_tree <- ggtree(bird_tree,layout="fan",branch.length = "none",open.angle = 25) +
  geom_rootedge(TRUE)
nicer_tree_rotated <- rotate_tree(nicer_tree,angle=90)
#
bird_data$coop<- as.factor(bird_data$COOP2)
tree_2 <- nicer_tree_rotated +
  geom_fruit(data=bird_data, # Data
             geom=geom_tile, # Plots 'tiles' (squares) onto each tip 
             position=position_identityx(hexpand=33), # Adjusts how far away the tiles are 
             mapping=aes(y=animal,fill=coop), # Analogous to ggplot aes()
             color = "white", # Colour of outline round the tiles (white makes it look lik lwd = 0.2, # Width of line between tiles
             linetype = 1, # Default - other numbers make the line dashes, dotted etc. 
             axis.params=list( # Add label to the geom_tile - by adding an x-axis
               axis="x",
               text = "coop", # Label to plot
               text.size = 3.5, # Size of text
               hjust = 0, # Adjust position of text relative to the geom_tile 
               vjust = 0.8,
               text.angle=360,
               line.colour="white"), # Set to white so axis line is not visible
             offset = 4, # Fine-scale adjustment of space between tree & layers
             pwidth=0.25) + # Width of whole plot
  scale_fill_manual(values=c("#999999","#CC79A7"))
#
tree_2
```

# PGLS models of the bird dataset
## Running all models

```{r bird_PGLS_main}
bird_data2<- bird_data
rownames(bird_data2)<- bird_data$animal
bird_tree2<- bird_tree
## Averages only
pgls_TMPavg<- phyloglm(COOP2~TMP_avg_tr, 
                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_PREavg<- phyloglm(COOP2~PRE_avg_tr, 
                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE", btol= 20)
pgls_DTRavg<- phyloglm(COOP2~DTR_avg_tr, 
                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_TMPavg_PREavg<- phyloglm(COOP2~TMP_avg_tr+PRE_avg_tr, 
                              data=bird_data2, phy=bird_tree2, method= "logistic_MPLE", btol= 20)
pgls_TMPavg_DTRavg<- phyloglm(COOP2~TMP_avg_tr+DTR_avg_tr, 
                              data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_PREavg_DTRavg<- phyloglm(COOP2~PRE_avg_tr+DTR_avg_tr, 
                              data=bird_data2, phy=bird_tree2, method= "logistic_MPLE", btol=20)
## Adding standard deviation
pgls_TMPavg_PREavg_DTRavg<- phyloglm(COOP2~TMP_avg_tr+PRE_avg_tr+DTR_avg_tr, 
                                     data=bird_data2, phy=bird_tree2, method= "logistic_MPLE", btol=20)
pgls_TMPavg_DTRavg_TMPsd<- phyloglm(COOP2~TMP_avg_tr+DTR_avg_tr+TMP_sd, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_TMPavg_DTRavg_PREsd<- phyloglm(COOP2~TMP_avg_tr+DTR_avg_tr+PRE_sd_tr, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE", btol=20)
pgls_TMPavg_DTRavg_DTRsd<- phyloglm(COOP2~TMP_avg_tr+DTR_avg_tr+DTR_sd, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
## Try dropping one variables
pgls_TMPavg_TMPsd<- phyloglm(COOP2~TMP_avg_tr+TMP_sd, 
                             data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd<- phyloglm(COOP2~DTR_avg_tr+TMP_sd, 
                             data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
## Spectral entropy predictabilities
pgls_DTRavg_TMPsd_TMPprd<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+TMP_prd_entropy, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_PREprd<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+PRE_prd_entropy, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_DTRprd<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+DTR_prd_entropy, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
## Colwell's predictabilities
pgls_DTRavg_TMPsd_TMPprdColBot<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+TMP_prd_Colwell_Botero, 
                                          data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_PREprdColBot<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+PRE_prd_Colwell_Botero, 
                                          data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_TMPprdCol<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+TMP_prd_Colwell_25, 
                                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_PREprdCol<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+PRE_prd_Colwell_25, 
                                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_DTRavg_TMPsd_DTRprdCol<- phyloglm(COOP2~DTR_avg_tr+TMP_sd+DTR_prd_Colwell_25, 
                                       data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
## Try dropping some predictors
pgls_DTRavg_TMPprdColBot<- phyloglm(COOP2~DTR_avg_tr+TMP_prd_Colwell_Botero, 
                                    data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
pgls_TMPsd_TMPprdColBot<- phyloglm(COOP2~TMP_sd+TMP_prd_Colwell_Botero, 
                                   data=bird_data2, phy=bird_tree2, method= "logistic_MPLE",btol=20)
## R2 analysis
pgls_phy_only<- phyloglm(COOP2~1, data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
glm_DTRavg_TMPprdColBot<- glm(COOP2~DTR_avg_tr+TMP_prd_Colwell_Botero,
                              data= bird_data2, family= "binomial")
pgls_TMPprdColBot<- phyloglm(COOP2~TMP_prd_Colwell_Botero, 
                             data=bird_data2, phy=bird_tree2, method= "logistic_MPLE")
```

## Summary of all models

We made models with averages of climatic variables first, then tried dropping some of the predictors before adding standard deviations. We then tried reducing the number of predictors for the temporary best model before adding environmental predictabilities. After the last round of attempt to drop predictors, we reached the fittest model for the dataset. All models generated in this process are summarised in Table 2.

```{r bird_PGLS_table}
models<- c("pgls_TMPavg","pgls_PREavg","pgls_DTRavg","pgls_TMPavg_PREavg","pgls_TMPavg_DTRavg","pgls_PREavg_DTRavg","pgls_TMPavg_PREavg_DTRavg",
           "pgls_TMPavg_DTRavg_TMPsd","pgls_TMPavg_DTRavg_PREsd","pgls_TMPavg_DTRavg_DTRsd",
           "pgls_TMPavg_TMPsd","pgls_DTRavg_TMPsd",
           "pgls_DTRavg_TMPsd_TMPprd","pgls_DTRavg_TMPsd_PREprd","pgls_DTRavg_TMPsd_DTRprd",
           "pgls_DTRavg_TMPsd_TMPprdColBot","pgls_DTRavg_TMPsd_PREprdColBot",
           "pgls_DTRavg_TMPsd_TMPprdCol","pgls_DTRavg_TMPsd_PREprdCol","pgls_DTRavg_TMPsd_DTRprdCol",
           "pgls_DTRavg_TMPprdColBot","pgls_TMPsd_TMPprdColBot",
           "pgls_phy_only","glm_DTRavg_TMPprdColBot","pgls_TMPprdColBot")
##
mod1.1<- c("PGLS","TMPavg","","",round(AIC(pgls_TMPavg), 3))
mod1.2<- c("PGLS","PREavg","","",round(AIC(pgls_PREavg), 3))
mod1.3<- c("PGLS","DTRavg","","",round(AIC(pgls_DTRavg), 3))
mod1.4<- c("PGLS","TMPavg","PREavg","",round(AIC(pgls_TMPavg_PREavg), 3))
mod1.5<- c("PGLS","TMPavg","DTRavg","",round(AIC(pgls_TMPavg_DTRavg), 3))
mod1.6<- c("PGLS","PREavg","DTRavg","",round(AIC(pgls_PREavg_DTRavg), 3))
mod1.7<- c("PGLS","TMPavg","PREavg","DTRavg",round(AIC(pgls_TMPavg_PREavg_DTRavg), 3))
##
mod2.1<- c("PGLS","TMPavg","DTRavg","TMPsd",round(AIC(pgls_TMPavg_DTRavg_TMPsd), 3))
mod2.2<- c("PGLS","TMPavg","DTRavg","PREsd",round(AIC(pgls_TMPavg_DTRavg_PREsd), 3))
mod2.3<- c("PGLS","TMPavg","DTRavg","DTRsd",round(AIC(pgls_TMPavg_DTRavg_DTRsd), 3))
mod3.1<- c("PGLS","TMPavg","TMPsd","",round(AIC(pgls_TMPavg_TMPsd), 3))
mod3.2<- c("PGLS","DTRavg","TMPsd","",round(AIC(pgls_DTRavg_TMPsd), 3))
##
mod4.1<- c("PGLS","DTRavg","TMPsd","TMPprd",round(AIC(pgls_DTRavg_TMPsd_TMPprd), 3))
mod4.2<- c("PGLS","DTRavg","TMPsd","PREprd",round(AIC(pgls_DTRavg_TMPsd_PREprd), 3))
mod4.3<- c("PGLS","DTRavg","TMPsd","DTRprd",round(AIC(pgls_DTRavg_TMPsd_DTRprd), 3))
mod4.4<- c("PGLS","DTRavg","TMPsd","TMPprdColBot",round(AIC(pgls_DTRavg_TMPsd_TMPprdColBot), 3))
mod4.5<- c("PGLS","DTRavg","TMPsd","PREprdColBot",round(AIC(pgls_DTRavg_TMPsd_PREprdColBot), 3))
mod4.6<- c("PGLS","DTRavg","TMPsd","TMPprdCol25",round(AIC(pgls_DTRavg_TMPsd_TMPprdCol), 3))
mod4.7<- c("PGLS","DTRavg","TMPsd","PREprdCol25",round(AIC(pgls_DTRavg_TMPsd_PREprdCol), 3))
mod4.8<- c("PGLS","DTRavg","TMPsd","DTRprdCol25",round(AIC(pgls_DTRavg_TMPsd_DTRprdCol), 3))
##
mod5.1<- c("PGLS","DTRavg","TMPprdColBot","",round(AIC(pgls_DTRavg_TMPprdColBot), 3))
mod5.2<- c("PGLS","TMPsd","TMPprdColBot","",round(AIC(pgls_TMPsd_TMPprdColBot), 3))
mod5.3<- c("PGLS","TMPprdColBot","","",round(AIC(pgls_TMPprdColBot), 3))
##
mod6.1<- c("PGLS","","","",round(AIC(pgls_phy_only), 3))
mod6.2<- c("GLM","DTRavg","TMPprdColBot","",round(AIC(glm_DTRavg_TMPprdColBot), 3))
##
table<- rbind(mod1.1, mod1.2,mod1.3,mod1.4,mod1.5,mod1.6,mod1.7,
              mod2.1,mod2.2,mod2.3, mod3.1, mod3.2,
              mod4.1,mod4.2,mod4.3,mod4.4,mod4.5,mod4.6,mod4.7,mod4.8,
              mod5.1,mod5.2,mod5.3,mod6.1,mod6.2)
rownames(table)<- NULL
colnames(table)<- c("Type", "Predictor 1", "Predictor 2", "Predictor 3", "AIC")
knitr::kable(table, "latex", align=c("l","c","c","c","c"), booktabs = T, caption= "Summary of all models.") %>%
  group_rows("Average only", 1, 7) %>%
  group_rows("Adding standard deviation", 8, 10) %>%
  group_rows("Try dropping predictors", 11, 12) %>%
  group_rows("Adding predictabilities", 13, 20) %>%
  group_rows("Try dropping predictors", 21, 23) %>%
  group_rows("Reference models for R2 calculation", 24, 25) %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

The fittest model is with average DTR and Boltero's binning method of Colwell's predictability on temperature (AIC of 179.961).

## Partial R2 analysis for the fittest model

The only available partial $R^2$ for phylogenetic logistic regression is likelihood ($R^2$-lik), we calculate it using __rr2__ package.

```{r bird_R2_table}
r1<- c("Overall", round(R2_lik(mod= pgls_DTRavg_TMPprdColBot), 3))
r2<- c("All fixed effects", round(R2_lik(mod= pgls_DTRavg_TMPprdColBot, pgls_phy_only), 3))
r3<- c("Phylogenetic effects", round(R2_lik(mod= pgls_DTRavg_TMPprdColBot, glm_DTRavg_TMPprdColBot), 3))
r4<- c("DTRavg", round(R2_lik(mod= pgls_DTRavg_TMPprdColBot, pgls_TMPprdColBot),3))
r5<- c("TMPprdColBot", round(R2_lik(mod= pgls_DTRavg_TMPprdColBot, pgls_DTRavg),3))
#
table<- rbind(r1,r2,r3,r4,r5)
rownames(table)<- NULL
colnames(table)<- c("Variables", "R2")
knitr::kable(table, "latex", align=c("l","l"), booktabs = T, caption= "Partial R2 analysis of the fittest model.") %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

# Basic diagnostic of the ant dataset

## Table of abbreviations

```{r abbr_table_ant, echo=FALSE, warning= FALSE}
abbr<- c("TMP_avg", "TMP_sd", "TMP_prd_entropy", "TMP_prd_Colwell_Botero", "TMP_prd_Colwell_25",
         "PRE_avg", "PRE_sd", "PRE_prd_entropy", "PRE_prd_Colwell_Botero", "PRE_prd_Colwell_25",
         "DTR_avg", "DTR_sd", "DTR_prd_entropy", "DTR_prd_Colwell_25")
full<- c("Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictability using Carlos Botero's binning", "Colwell's predictabilty with dynamic bin size",
         "Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictability using Carlos Botero's binning", "Colwell's predictabilty with dynamic bin size",
         "Average", "Standard deviation", "Predictability with normalised spectral entropy", "Colwell's predictabilty with dynamic bin size")
trsf<- c("none", "sqrt", "sqrt", "none", "none", 
         "sqrt", "log", "none", "sqrt", "none", 
         "none", "sqrt", "sqrt", "sqrt")
table<- cbind(abbr, full, trsf)
colnames(table)<- c("Name", "Description", "Transformation")
knitr::kable(table, "latex", align=c("l","l","c"), booktabs = T, caption= "The abbreviations used in axes titles and column names of the data.") %>%
  group_rows("Temperature", 1, 5) %>%
  group_rows("Precipiration (rainfall)", 6, 10) %>%
  group_rows("Diurnal temperature range", 11, 14) %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

## Read-in the ant data

```{r read-in_ant}
# Read in the files
ant_data2<- read.csv("/Users/louis.bell-roberts/Documents/DTP_1st_project_rotation/Data/Ant_environment/Subsetted_data/Ant_Env_Ming_230312.csv")
ant_tree2<- read.nexus("/Users/louis.bell-roberts/Downloads/Ant_tree_Ming_230312.nex")
# For PhyloLM data structure
# ant_data2<- ant_data[ , which( !duplicated( t( ant_data ) ) ), with = FALSE ]
rownames(ant_data2)<- ant_data2$valid_species_name
```

## Normality check of the climatic predictors (averages)

```{r ant_normality, fig.width=8,fig.height=2.5,fig.cap="Climate variables normality check."}
a<- ggqq(ant_data2$temp_avg_avg, observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (TMP_avg)")
b<- ggqq(sqrt(ant_data2$pre_avg_avg), observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (sqrt(PRE_avg))")
c<- ggqq(ant_data2$DTR_avg_avg, observedOnX= FALSE)+
  xlab("Theoretical quantiles \n (DTR_avg)")
ggarrange(a,b,c,nrow=1, labels=c("a","b","c"))
```

## How does polymorphic worker trait distribute across climatic variables?

```{r ant_binary_pattern, fig.width=8, fig.height=2.5, fig.cap="Climate variables against polymorphic worker trait in ants."}
a<- ggplot(ant_data2, aes(x=temp_avg_avg, y=poly_id))+
  geom_point(alpha= 0.02)+
  ylab("Polymorphic worker")
b<- ggplot(ant_data2, aes(x=sqrt(pre_avg_avg), y=poly_id))+
  geom_point(alpha= 0.02)+
  ylab("Polymorphic worker")
c<- ggplot(ant_data2, aes(x=DTR_avg_avg, y=poly_id))+
  geom_point(alpha= 0.02)+
  ylab("Polymorphic worker")
ggarrange(a,b,c,nrow=1, labels=c("a","b","c"))
```

## How does polymorphic worker trait distribute across the phelogenetic tree?

```{r ant_tree, fig.width=8, fig.height=8, fig.cap="Phylogenetic tree of all ant species in the dataset."}
nicer_tree <- ggtree(ant_tree2,layout="fan",branch.length = "none",open.angle = 25) +
  geom_rootedge(TRUE)
nicer_tree_rotated <- rotate_tree(nicer_tree,angle=90)
#
ant_data2$poly<- as.factor(ant_data2$poly_id)
#
tree_2 <- nicer_tree_rotated +
  geom_fruit(data=ant_data2, # Data
             geom=geom_tile, # Plots 'tiles' (squares) onto each tip 
             position=position_identityx(hexpand=43), # Adjusts how far away the tiles are 
             mapping=aes(y=valid_species_name,fill=poly), # Analogous to ggplot aes()
             color = "white", # Colour of outline round the tiles (white makes it look lik lwd = 0.2, # Width of line between tiles
             linetype = 1, # Default - other numbers make the line dashes, dotted etc. 
             lwd= 0,
             axis.params=list( # Add label to the geom_tile - by adding an x-axis
               axis="x",
               text = "poly", # Label to plot
               text.size = 3.5, # Size of text
               hjust = -0.25, # Adjust position of text relative to the geom_tile 
               vjust = 0,
               text.angle=360,
               line.colour="white"), # Set to white so axis line is not visible
             offset = 4, # Fine-scale adjustment of space between tree & layers
             pwidth=0.25) + # Width of whole plot
  scale_fill_manual(values=c("#999999","#CC79A7"))
#
tree_2
```

# PGLS models of the ant dataset 
## Running all models

```{r ant_PGLS_main}
# Averages
pgls_TMPavg<- phyloglm(poly_id~temp_avg_avg, 
                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg<- phyloglm(poly_id~sqrt(pre_avg_avg), 
                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_DTRavg<- phyloglm(poly_id~DTR_avg_avg, 
                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_TMPavg_PREavg<- phyloglm(poly_id~temp_avg_avg+ sqrt(pre_avg_avg), 
                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_TMPavg_DTRavg<- phyloglm(poly_id~temp_avg_avg+ DTR_avg_avg, 
                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_DTRavg<- phyloglm(poly_id~sqrt(pre_avg_avg)+ DTR_avg_avg, 
                              data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_TMPavg_PREavg_DTRavg<- phyloglm(poly_id~ temp_avg_avg+ sqrt(pre_avg_avg)+ DTR_avg_avg, 
                                     data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 40)
# Adding standard deviation
pgls_PREavg_TMPsd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg), 
                             data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_PREsd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ log(pre_sd_avg), 
                             data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_DTRsd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(DTR_sd_avg), 
                             data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
# Dropping
pgls_TMPsd<- phyloglm(poly_id~sqrt(temp_sd_avg), 
                      data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
# Adding predictability
pgls_PREavg_TMPsd_TMPprd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ sqrt(temp_prd_entropy_avg), 
                                    data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_PREprd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ pre_prd_entropy_avg, 
                                    data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_DTRprd<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ sqrt(DTR_prd_entropy_avg), 
                                    data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_TMPprdColBot<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ temp_prd_Colwell_avg, 
                                          data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_PREprdColBot<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ sqrt(pre_prd_Colwell_avg), 
                                          data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_TMPprdCol<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ temp_prd_ColwellDym_avg, 
                                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_PREprdCol<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ pre_prd_ColwellDym_avg, 
                                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_PREavg_TMPsd_DTRprdCol<- phyloglm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ sqrt(DTR_prd_ColwellDym_avg), 
                                       data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
# Dropping
pgls_PREavg_TMPprdCol<- phyloglm(poly_id~sqrt(pre_avg_avg)+ temp_prd_ColwellDym_avg, 
                                data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
pgls_TMPsd_TMPprdCol<- phyloglm(poly_id~ sqrt(temp_sd_avg)+ temp_prd_ColwellDym_avg, 
                                data=ant_data2, phy=ant_tree2, method= "logistic_MPLE", btol= 30)
# Reference models
glm_PREavg_TMPsd_TMPprdCol<- glm(poly_id~sqrt(pre_avg_avg)+ sqrt(temp_sd_avg)+ temp_prd_ColwellDym_avg,
                                 data= ant_data2, family= "binomial")
pgls_phy_only<- phyloglm(poly_id~1, 
                         data=ant_data2, phy=ant_tree2, method= "logistic_MPLE")
```

## Summary of all models

```{r ant_PGLS_table}
models<- c("pgls_TMPavg","pgls_PREavg","pgls_DTRavg","pgls_TMPavg_PREavg","pgls_TMPavg_DTRavg","pgls_PREavg_DTRavg","pgls_TMPavg_PREavg_DTRavg",
           "pgls_PREavg_TMPsd","pgls_PREavg_PREsd","pgls_PREavg_DTRsd",
           "pgls_TMPsd",
           "pgls_PREavg_TMPsd_TMPprd","pgls_PREavg_TMPsd_PREprd","pgls_PREavg_TMPsd_DTRprd",
           "pgls_PREavg_TMPsd_TMPprdColBot","pgls_PREavg_TMPsd_PREprdColBot",
           "pgls_PREavg_TMPsd_TMPprdCol","pgls_PREavg_TMPsd_PREprdCol","pgls_PREavg_TMPsd_DTRprdCol",
           "pgls_PREavg_TMPprdCol","pgls_TMPsd_TMPprdCol",
           "glm_PREavg_TMPsd_TMPprdCol","pgls_phy_only")
#
##
mod1.1<- c("PGLS","TMPavg","","",round(AIC(pgls_TMPavg), 3))
mod1.2<- c("PGLS","PREavg","","",round(AIC(pgls_PREavg), 3))
mod1.3<- c("PGLS","DTRavg","","",round(AIC(pgls_DTRavg), 3))
mod1.4<- c("PGLS","TMPavg","PREavg","",round(AIC(pgls_TMPavg_PREavg), 3))
mod1.5<- c("PGLS","TMPavg","DTRavg","",round(AIC(pgls_TMPavg_DTRavg), 3))
mod1.6<- c("PGLS","PREavg","DTRavg","",round(AIC(pgls_PREavg_DTRavg), 3))
mod1.7<- c("PGLS","TMPavg","PREavg","DTRavg",round(AIC(pgls_TMPavg_PREavg_DTRavg), 3))
##
mod2.1<- c("PGLS","PREavg","TMPsd","",round(AIC(pgls_PREavg_TMPsd), 3))
mod2.2<- c("PGLS","PREavg","PREsd","",round(AIC(pgls_PREavg_PREsd), 3))
mod2.3<- c("PGLS","PREavg","DTRsd","",round(AIC(pgls_PREavg_DTRsd), 3))
mod3.1<- c("PGLS","TMPsd","","",round(AIC(pgls_TMPsd), 3))
##
mod4.1<- c("PGLS","PREavg","TMPsd","TMPprd",round(AIC(pgls_PREavg_TMPsd_TMPprd), 3))
mod4.2<- c("PGLS","PREavg","TMPsd","PREprd",round(AIC(pgls_PREavg_TMPsd_PREprd), 3))
mod4.3<- c("PGLS","PREavg","TMPsd","DTRprd",round(AIC(pgls_PREavg_TMPsd_DTRprd), 3))
mod4.4<- c("PGLS","PREavg","TMPsd","TMPprdColBot",round(AIC(pgls_PREavg_TMPsd_TMPprdColBot), 3))
mod4.5<- c("PGLS","PREavg","TMPsd","PREprdColBot",round(AIC(pgls_PREavg_TMPsd_PREprdColBot), 3))
mod4.6<- c("PGLS","PREavg","TMPsd","TMPprdCol25",round(AIC(pgls_PREavg_TMPsd_TMPprdCol), 3))
mod4.7<- c("PGLS","PREavg","TMPsd","PREprdCol25",round(AIC(pgls_PREavg_TMPsd_PREprdCol), 3))
mod4.8<- c("PGLS","PREavg","TMPsd","DTRprdCol25",round(AIC(pgls_PREavg_TMPsd_DTRprdCol), 3))
##
mod5.1<- c("PGLS","PREavg","TMPprdCol25","",round(AIC(pgls_PREavg_TMPprdCol), 3))
mod5.2<- c("PGLS","TMPsd","TMPprdCol25","",round(AIC(pgls_TMPsd_TMPprdCol), 3))
##
mod6.1<- c("PGLS","","","",round(AIC(pgls_phy_only), 3))
mod6.2<- c("GLM","PREavg","TMPsd","TMPprdCol25",round(AIC(glm_PREavg_TMPsd_TMPprdCol), 3))
##
table<- rbind(mod1.1, mod1.2,mod1.3,mod1.4,mod1.5,mod1.6,mod1.7,
              mod2.1,mod2.2,mod2.3, mod3.1,
              mod4.1,mod4.2,mod4.3,mod4.4,mod4.5,mod4.6,mod4.7,mod4.8,
              mod5.1,mod5.2,mod6.1,mod6.2)
rownames(table)<- NULL
colnames(table)<- c("Type", "Predictor 1", "Predictor 2", "Predictor 3", "AIC")
knitr::kable(table, "latex", align=c("l","c","c","c","c"), booktabs = T, caption= "Summary of all models.") %>%
  group_rows("Average only", 1, 7) %>%
  group_rows("Adding standard deviation", 8, 10) %>%
  group_rows("Try dropping predictors", 11, 11) %>%
  group_rows("Adding predictabilities", 12, 19) %>%
  group_rows("Try dropping predictors", 20, 21) %>%
  group_rows("Reference models for R2 calculation", 22, 23) %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

The fittest model is with average rainfall, standard deviation of temperature, and Colwell's predictability with dynamic bin size on temperature (AIC of 3186.636). 

## Partial R2 analysis for the fittest model

```{r ant_R2_table}
r1<- c("Overall", round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol), 3))
r2<- c("All fixed effects", round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol, pgls_phy_only), 3))
r3<- c("Phylogenetic effects", round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol, glm_PREavg_TMPsd_TMPprdCol), 3))
r4<- c("PREavg", round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol, pgls_TMPsd_TMPprdCol),3))
r5<- c("TMPsd", round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol, pgls_PREavg_TMPprdCol),3))
r6<- c("TMPprdCol25",round(R2_lik(mod= pgls_PREavg_TMPsd_TMPprdCol, pgls_PREavg_TMPsd),3))
#
table<- rbind(r1,r2,r3,r4,r5,r6)
rownames(table)<- NULL
colnames(table)<- c("Variables", "R2")
knitr::kable(table, "latex", align=c("l","l"), booktabs = T, caption= "Partial R2 analysis of the fittest model.") %>%
  row_spec(0, bold= T) %>%
  column_spec(1, italic = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

# Summary and thoughts

* Cooperative breeding in birds is best explained by (i) average diurnal thermal range and (ii) Boltero's binning method of Colwell's predictibility on temperature.
* Polymorphic worker caste in ants is best explained by (i) average precipitation (rainfall), (ii) standard deviation of temperature, and (iii) Colwell's predictability of temperature.
* Take home message is predictability can matter and improve the model, but the biological meaning of the predictabilities is subject to debate (and people need to be careful when using predictability in comparative studies)
* Next: run a Bayesian equivalent result to strengthen the conclusion? There are two routes available:
  + MCMCglmm by Jarrod Hadfield
    - pros: easy and quick to make workable model
    - cons: hard to do model selection (DIC is not reliable for non-Gaussian regression)
  + BRMS by Paul-Christian Buerkner
    - pros: powerful tool with better algorithm and model selection is doable
    - cons: technical problems still unable to resolve for model execution or model selection
